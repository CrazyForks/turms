<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>架构 | Turms Documentation</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/turms/assets/css/0.styles.b12f47e2.css" as="style"><link rel="preload" href="/turms/assets/js/app.1a1cee5f.js" as="script"><link rel="preload" href="/turms/assets/js/2.a10f772c.js" as="script"><link rel="preload" href="/turms/assets/js/12.68a59a93.js" as="script"><link rel="prefetch" href="/turms/assets/js/10.e0863d19.js"><link rel="prefetch" href="/turms/assets/js/11.3359e765.js"><link rel="prefetch" href="/turms/assets/js/13.4fe3483b.js"><link rel="prefetch" href="/turms/assets/js/14.fbb9a423.js"><link rel="prefetch" href="/turms/assets/js/15.9e7ad567.js"><link rel="prefetch" href="/turms/assets/js/16.7c432781.js"><link rel="prefetch" href="/turms/assets/js/17.90cd09dd.js"><link rel="prefetch" href="/turms/assets/js/18.f953391a.js"><link rel="prefetch" href="/turms/assets/js/19.d037018d.js"><link rel="prefetch" href="/turms/assets/js/20.1b24e69d.js"><link rel="prefetch" href="/turms/assets/js/21.96f207df.js"><link rel="prefetch" href="/turms/assets/js/22.6336ec04.js"><link rel="prefetch" href="/turms/assets/js/23.48ff6209.js"><link rel="prefetch" href="/turms/assets/js/3.8f7482d1.js"><link rel="prefetch" href="/turms/assets/js/4.5f60d4ea.js"><link rel="prefetch" href="/turms/assets/js/5.f18538b5.js"><link rel="prefetch" href="/turms/assets/js/6.16919379.js"><link rel="prefetch" href="/turms/assets/js/7.f531c78d.js"><link rel="prefetch" href="/turms/assets/js/8.1496bc21.js"><link rel="prefetch" href="/turms/assets/js/9.90cae9b2.js">
    <link rel="stylesheet" href="/turms/assets/css/0.styles.b12f47e2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/turms/" class="home-link router-link-active"><!----> <span class="site-name">Turms Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/turms-im/turms" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/turms-im/turms" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>介绍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/turms/intro/" class="sidebar-link">Turms 是什么</a></li><li><a href="/turms/intro/features.html" class="sidebar-link">主要特性</a></li><li><a href="/turms/intro/redevelopment.html" class="sidebar-link">关于二次开发</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>业务功能</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/turms/features/" class="sidebar-link">业务功能介绍</a></li><li><a href="/turms/features/simultaneous-login.html" class="sidebar-link">登陆设备识别</a></li><li><a href="/turms/features/user.html" class="sidebar-link">用户信息功能</a></li><li><a href="/turms/features/group.html" class="sidebar-link">群组类型配置</a></li><li><a href="/turms/features/message.html" class="sidebar-link">业务消息类型</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发者文档</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/turms/for-developers/quick-start.html" class="sidebar-link">Quick Start</a></li><li><a href="/turms/for-developers/architecture.html" class="active sidebar-link">架构</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/turms/for-developers/config.html" class="sidebar-link">配置参数</a></li><li><a href="/turms/for-developers/admin-api.html" class="sidebar-link">管理接口</a></li><li><a href="/turms/for-developers/client-api.html" class="sidebar-link">客户端接口</a></li><li><a href="/turms/for-developers/status-code.html" class="sidebar-link">状态码</a></li><li><a href="/turms/for-developers/custom-plugin.html" class="sidebar-link">自定义插件</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="架构"><a href="#架构" class="header-anchor">#</a> 架构</h3> <p>（TODO）</p> <p>特别说明：在大部分即时通讯的技术架构中，都使用了独立的接入层，并通常带有专门的用户状态管理集群、服务注册中心集群与配置中心集群等。而Turms解决方案最大程度地简化了架构，无需接入上述架构内容。Turms的架构最多只有两层，即：负载均衡层与Turms服务端集群（补充：Turms服务端集群自身也有负载均衡功能）。一方面，该架构的Overhead开销最小。另一方面，可以极大简化开发者的运维工作。</p> <h3 id="负载均衡"><a href="#负载均衡" class="header-anchor">#</a> 负载均衡</h3> <p>负载均衡的重要性不言而喻，为更好的与负载均衡服务器（负载均衡层）相搭配，Turms服务端提供了“负责用户策略”与“非负责用户策略”，并推荐您在负载均衡服务端处实现相应的算法（下文的“带业务判断的负载均衡架构”讲解了大致流程，您可以自行实现，或等v1.2.0版本时Turms解决方案也将提供具体的配置与代码），二者相配合，能实现Turms集群性能与可用性的最优解。</p> <h4 id="负责用户策略"><a href="#负责用户策略" class="header-anchor">#</a> 负责用户策略</h4> <p>负责用户策略指的是：每个Turms服务端会根据一致性Hash算法，被动态地分配去管理不同用户（根据用户ID），并对这些用户负责。一名用户有且仅有一个服务端对其负责。</p> <h5 id="具体场景"><a href="#具体场景" class="header-anchor">#</a> 具体场景</h5> <ul><li>如果一名用户试图与不对其负责的Turms服务端建立连接，则在该策略下，Turms服务端会在WebSocket的Handshake阶段主动拒绝与其建立连接，并根据配置，返回对其负责的服务端地址（IP+端口）。默认情况下，Turms客户端会自动根据该地址与新服务端建立连接。</li> <li>如果一名用户与不对其负责的Turms服务端已建立了连接（出现这种情况是因为其他服务端的上线与下线操作，导致Turms服务端的管辖范围发送了变化），则Turms服务端会主动断开连接，并根据配置，返回对其负责的服务端地址（IP+端口）。默认情况下，Turms客户端会自动根据该地址与新服务端建立连接。</li></ul> <p>该策略的特点是运作高效，可以通过本地简易的算法，来得知负责管理某用户的服务端，并直接与其进行交互。但缺点在于对于已经建立的连接，由于当服务端上下线时会导致服务端的管辖范围发生变化，从而产生惊群效应，使得一批已建立连接的用户被迫下线，当这些用户自动重连时又容易产生流量洪流，加大服务雪崩的概率。尤其是在服务端不稳定时，多个服务端反反复复上下线时，该类问题更为严重。</p> <p>为了解决类似问题，Turms服务端又提供了非负责用户策略作为服务兜底策略（补充：负责用户策略是无法关闭的，而非负责用户策略可以关闭，并且非负责用户策略默认启动）。</p> <h4 id="非负责用户策略（尚未提供，将在4月9号之前提供）"><a href="#非负责用户策略（尚未提供，将在4月9号之前提供）" class="header-anchor">#</a> 非负责用户策略（尚未提供，将在4月9号之前提供）</h4> <p>特别注意：该策略属于服务补偿（服务兜底）策略，是对负责用户策略的补充，而非主策略。</p> <p>用户进入非负责状态的任意条件有：</p> <ul><li>当一名用户试图与不对其负责的Turms服务端建立连接时</li> <li>原本一个对某用户负责的服务端，因为其他服务端的上线或下线操作，导致服务端负责的用户范围发生了变化，使得用户进入到了不负责的状态</li></ul> <p>该策略与传统的有状态服务架构的思路类似，传统的有状态服务架构通常将状态由从业务服务端中剥离出来，并交由专门的状态集群管理（通常是Redis或Memcached集群），而状态集群对外提供一致的状态表述，由此实现状态的一致性。非负责用户策略实现了类似的思想。</p> <h5 id="具体场景-2"><a href="#具体场景-2" class="header-anchor">#</a> 具体场景</h5> <ul><li><p>对于非负责用户发来的连接请求，Turms服务端会接受其请求并与其建立连接，同时会将该用户的ID与当前服务端的ID记录到一个全局的内存表当中。</p></li> <li><p>对于已经建立连接的非负责用户，Turms不会关闭与其的连接，而是把其信息记录到这张全局表当中</p></li></ul> <p>（补充：在Turms服务端配置中，这两个功能是否启动是独立设置的）</p> <p>（特别值得一提的是：这个全局的内存表由Hazelcast的ReplicatedMap实现，其提供冗余的副本数据，而非分片数据，因此每个Turms服务端都在本地存有这张表。并且该表非强一致，但最终一致，加之该表增删操作非同步操作，可能会出现小部分用户状态不一致的问题。在这个问题上，Turms通过给非负责用户记录设定TTL时间（可配置），当到达TTL时间时，则服务端主动强制与该非负责用户，并告知对其负责的服务端地址，以解决可能出现的小部分用户状态不一致的问题，同时也避免了一刀斩式断连情况下出现的流量洪流）</p> <p>而在每次需要对用户状态进行判断的时候，Turms服务端会先走非负责用户策略的逻辑，通过这张全局副本表判断用户状态，如果该表不存在该用户的信息，则说明他未与非负责的服务端建立连接，进而转入负责用户策略进行后续的判断逻辑。</p> <p>由此通过上述两种策略，互相取长补短。</p> <p>提醒：非负责用户策略是负责用户策略的服务兜底策略，在实际使用中切不可主客颠倒。</p> <h4 id="负载均衡层（可选）"><a href="#负载均衡层（可选）" class="header-anchor">#</a> 负载均衡层（可选）</h4> <p>出于安全、高可用与后期运维等原因，负载均衡层通常在生产环境是必不可少的。这里我们主要讲解下Turms自身的负载均衡策略在不同负载均衡架构下的大致运用。</p> <h5 id="无负载均衡层架构"><a href="#无负载均衡层架构" class="header-anchor">#</a> 无负载均衡层架构</h5> <p>这里指的无负载均衡架构指的是：用户直接通过真实IP访问Turms服务端，或者用户通过访问单条A记录的DNS服务端直接访问Turms服务端。如果非负责用户策略被关闭，那么在这种情况下，被用户直接访问的Turms服务端会在实际上变为路由服务端（注意：Turms所有服务端都有路由功能），Turms服务端会在内部集群中，自动查询对其负责的服务端。如果该服务端就是对其负责的服务端，则与该用户建立连接，否则拒绝连接，并告知其对其负责的服务端的地址（IP+端口）。</p> <p>如果非负责用户策略被启动，并且您还允许了用户可以与不对其负责的Turms服务端建立连接，则该服务端会一概直接建立连接，但这就会导致Turms内部的负载均衡功能失去意义。</p> <h5 id="带业务判断的负载均衡架构"><a href="#带业务判断的负载均衡架构" class="header-anchor">#</a> 带业务判断的负载均衡架构</h5> <p>这里指的带业务判断，即7层负载均衡，其本质与Turms自身的负载均衡策略一致，让Nginx在WebSocket的Handshake阶段，获取用户ID，再结合当前Turms集群状态（可通过dyups模块+Lua脚本。Turms会在v1.2.0版本中给出具体配置），计算出对其负责服务端地址，再将用户请求转发给该Turms服务端。</p> <p>由于负载均衡层在获取Turms集群状态时，会有一定的延迟。因此可能会出现一部分用户被转发给了不对其负责的Turms服务端，这时候就适合允许了用户可以与不对其负责的Turms服务端建立连接。</p> <h5 id="不带业务判断的负载均衡架构"><a href="#不带业务判断的负载均衡架构" class="header-anchor">#</a> 不带业务判断的负载均衡架构</h5> <p>不带业务判断的负载均衡架构可以自由配置，没有特殊之处。但都可以加上Nginx并实现上述逻辑，以变成带业务判断的负载均衡架构。因此无论是DNS+Nginx负载均衡架构、DNS+LVS+Nginx负载均衡架等架构都可以变为带业务判断的负载均衡架构。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2/2/2020, 9:24:56 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/turms/for-developers/quick-start.html" class="prev">
        Quick Start
      </a></span> <span class="next"><a href="/turms/for-developers/config.html">
        配置参数
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/turms/assets/js/app.1a1cee5f.js" defer></script><script src="/turms/assets/js/2.a10f772c.js" defer></script><script src="/turms/assets/js/12.68a59a93.js" defer></script>
  </body>
</html>
